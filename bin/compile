#!/usr/bin/env bash

# Fail fast and fail hard.
set -e

# Prepend proper path for virtualenv hackery. This will be deprecated soon.
export PATH=:/usr/local/bin:$PATH

# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2

export BUILD_DIR

# Syntax sugar.
function puts-step (){
  echo "-----> $@"
}

# ## Build Time
#
# Switch to the repo's context.
mkdir -p $BUILD_DIR/vendor/imagemagick
cd $BUILD_DIR/vendor/imagemagick

IM_LOCATION="im"

mkdir -p $IM_LOCATION

# Install ImageMagick
IM_VERSION="6.8.6-6"
IM_URL="https://assets.tandemstock.com.s3.amazonaws.com/im-$IM_VERSION.tar.gz"
puts-step "Bundling ImageMagick version $IM_VERSION"
curl --silent --max-time 120 --location "$IM_URL" | tar xz

# ufraw dependency
UFRAW_VERSION="0.19"
UFRAW_URL="https://assets.tandemstock.com.s3.amazonaws.com/ufraw-0.19.tar.gz"
puts-step "Bundling ufraw version $UFRAW_VERSION"
curl --silent --max-time 60 --location "$UFRAW_URL" | tar xz -C $IM_LOCATION

# remove imagemagick from gems cache
rm -rf $CACHE_DIR//vendor/bundle/ruby/1.9.1/gems/rmagick-*
rm -rf $CACHE_DIR//vendor/bundle/ruby/1.9.1/specifications/rmagick-*

echo "export PATH=:/app/vendor/imagemagick/bin:/app/vendor/imagemagick/im/bin:$PATH
export CFLAGS=\"-fopenmp -I/app/vendor/imagemagick/include/ImageMagick-6 $CFLAGS\"
export CPPFLAGS=\"-fopenmp -I/app/vendor/imagemagick/include/ImageMagick-6 $CPPFLAGS\"
export LDFLAGS=\"-fopenmp -I/app/vendor/imagemagick/include/ImageMagick-6 $LDFLAGS\"" > $ROOT_DIR/.set_env_after_compile

mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=:/app/vendor/imagemagick/bin:/app/vendor/imagemagick/im/bin:$PATH" > $BUILD_DIR/.profile.d/imagemagick.sh
